{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-5" style="max-width: 600px;">
  <h2 class="text-center mb-4">Book Your Session</h2>
  <form id="bookingForm" method="post" action="{% url 'book_facility' %}">
    {% csrf_token %}
    <!-- Basic fields (without date and time) -->
    <div class="mb-3">
      <label for="id_name" class="form-label">Name</label>
      <input type="text" class="form-control" id="id_name" name="name" placeholder="Your Name" required>
    </div>
    <div class="mb-3">
      <label for="id_facility_type" class="form-label">Facility Type</label>
      <select class="form-select" id="id_facility_type" name="facility_type" required>
        <option value="">Select a facility</option>
        <option value="gym">Gym</option>
        <option value="pool">Pool</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="id_location" class="form-label">Location</label>
      <select class="form-select" id="id_location" name="location" required>
        <option value="">Select a location</option>
        <option value="north">North Branch</option>
        <option value="south">South Branch</option>
        <option value="east">East Branch</option>
        <option value="west">West Branch</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="id_additional_info" class="form-label">Additional Info</label>
      <textarea class="form-control" id="id_additional_info" name="additional_info" rows="3" placeholder="Any additional details (optional)"></textarea>
    </div>
    <!-- Hidden fields for date and time (to be filled by the modal) -->
    <input type="hidden" id="id_date" name="date">
    <input type="hidden" id="id_time" name="time">
    
    <!-- Button triggers the Date/Time Modal -->
    <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#bookingModal">
      Next: Select Date & Time
    </button>
  </form>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <!-- Week Navigation (not yet functional, placeholders) -->
        <button type="button" class="btn btn-outline-secondary" id="prevWeek">
          <i class="bi bi-chevron-left"></i>
        </button>
        <h5 class="modal-title text-center flex-grow-1" id="bookingModalLabel">Select a Date</h5>
        <button type="button" class="btn btn-outline-secondary" id="nextWeek">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Days of the Week Row: will be generated dynamically -->
        <div class="d-flex justify-content-around mb-4" id="weekDays">
          <!-- Buttons for days will appear here -->
        </div>
        <!-- Available Time Slots -->
        <div class="d-flex flex-wrap justify-content-center gap-3" id="timeSlots">
          <!-- Static time slot buttons (9AM to 5PM) -->
          <button type="button" class="btn btn-warning">09:00</button>
          <button type="button" class="btn btn-warning">10:00</button>
          <button type="button" class="btn btn-warning">11:00</button>
          <button type="button" class="btn btn-warning">12:00</button>
          <button type="button" class="btn btn-warning">13:00</button>
          <button type="button" class="btn btn-warning">14:00</button>
          <button type="button" class="btn btn-warning">15:00</button>
          <button type="button" class="btn btn-warning">16:00</button>
          <button type="button" class="btn btn-warning">17:00</button>
        </div>
      </div>
      <div class="modal-footer">
        <!-- Confirm Booking Button -->
        <button type="button" class="btn btn-primary" id="confirmBooking">Confirm Booking</button>
      </div>
    </div>
  </div>
</div>


<!-- JavaScript to capture selected date/time (basic example) -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Function to generate the current week's days
    function generateWeekDays() {
      const weekContainer = document.getElementById("weekDays");
      weekContainer.innerHTML = ""; // Clear existing content

      const today = new Date();
      // Calculate Monday of the current week
      const currentDay = today.getDay(); // 0 (Sun) ... 6 (Sat)
      const diffToMonday = (currentDay === 0 ? -6 : 1 - currentDay);
      const monday = new Date(today);
      monday.setDate(today.getDate() + diffToMonday);

      // Generate buttons for 7 days starting from Monday
      for (let i = 0; i < 7; i++) {
        const day = new Date(monday);
        day.setDate(monday.getDate() + i);

        // Format the day as "Mon 12" using toLocaleDateString options
        const options = { weekday: 'short' };
        const weekday = day.toLocaleDateString(undefined, options);
        const dateNum = day.getDate();
        const formatted = `${weekday} ${dateNum}`;

        const button = document.createElement("button");
        button.type = "button";
        button.className = "btn btn-outline-light";
        button.textContent = formatted;

        // Disable the button if the day is in the past (compare without time)
        const dayOnly = new Date(day.getFullYear(), day.getMonth(), day.getDate());
        const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        if (dayOnly < todayOnly) {
          button.disabled = true;
          button.classList.add("disabled");
        }

        // Add click event to mark selection
        button.addEventListener("click", function() {
          // Remove 'active' class from all buttons
          document.querySelectorAll("#weekDays button").forEach(btn => btn.classList.remove("active"));
          // Mark the clicked button as active
          button.classList.add("active");
        });

        weekContainer.appendChild(button);
      }
    }

    generateWeekDays();

    // Optionally, add click listeners for the time slot buttons (similar approach)
    // For now, assume time slots are static

    // When the user clicks the Confirm Booking button:
    document.getElementById("confirmBooking").addEventListener("click", function() {
      // Check for selected day and time slot
      const selectedDayBtn = document.querySelector("#weekDays button.active");
      const selectedTimeBtn = document.querySelector("#timeSlots button.active");
      
      if (!selectedDayBtn || !selectedTimeBtn) {
        alert("Please select both a day and a time slot.");
        return;
      }
      
      // For demonstration, we'll simply log the values.
      // In production, you should assign these values to hidden form fields.
      console.log("Selected day:", selectedDayBtn.textContent);
      console.log("Selected time:", selectedTimeBtn.textContent);
      
      // Close the modal after selection:
      var bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
      bookingModal.hide();
      
      // Optionally, auto-submit the form if desired:
      // document.getElementById('bookingForm').submit();
    });

    // Mark time slot buttons as active when clicked
    document.querySelectorAll("#timeSlots button").forEach(button => {
      button.addEventListener("click", function() {
        document.querySelectorAll("#timeSlots button").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
      });
    });
  });
</script>
{% endblock %}
