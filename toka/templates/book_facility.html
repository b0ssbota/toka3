{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-5" style="max-width: 600px;">
  <h2 class="text-center mb-4">Book Your Session</h2>
  <form id="bookingForm" method="post" action="{% url 'book_facility' %}">
    {% csrf_token %}
    <!-- Basic fields (without date and time) -->
    <div class="mb-3">
      <label for="id_name" class="form-label">Name</label>
      <input type="text" class="form-control" id="id_name" name="name" placeholder="Your Name" required>
    </div>
    <div class="mb-3">
      <label for="id_facility_type" class="form-label">Facility Type</label>
      <select class="form-select" id="id_facility_type" name="facility_type" required>
        <option value="">Select a facility</option>
        <option value="gym">Gym</option>
        <option value="pool">Pool</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="id_location" class="form-label">Location</label>
      <select class="form-select" id="id_location" name="location" required>
        <option value="">Select a location</option>
        <option value="north">North Branch</option>
        <option value="south">South Branch</option>
        <option value="east">East Branch</option>
        <option value="west">West Branch</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="id_additional_info" class="form-label">Additional Info</label>
      <textarea class="form-control" id="id_additional_info" name="additional_info" rows="3" placeholder="Any additional details (optional)"></textarea>
    </div>
    <!-- Hidden fields for date and time (to be filled by the modal) -->
    <input type="hidden" id="id_date" name="date">
    <input type="hidden" id="id_time" name="time">
    
    <!-- Button triggers the Date/Time Modal -->
    <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#bookingModal">
      Next: Select Date & Time
    </button>
  </form>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <!-- Week Navigation -->
        <button type="button" class="btn btn-outline-secondary" id="prevWeek">
          <i class="bi bi-chevron-left"></i>
        </button>
        <h5 class="modal-title text-center flex-grow-1" id="bookingModalLabel">Select a Date</h5>
        <button type="button" class="btn btn-outline-secondary" id="nextWeek">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Days of the Week Row -->
        <div class="d-flex justify-content-around mb-4" id="weekDays">
          <!-- Buttons for days will be generated here -->
        </div>
        <!-- Available Time Slots -->
        <div class="d-flex flex-wrap justify-content-center gap-3" id="timeSlots">
          <!-- Static time slot buttons (9AM to 5PM) -->
          <button type="button" class="btn btn-warning">09:00</button>
          <button type="button" class="btn btn-warning">10:00</button>
          <button type="button" class="btn btn-warning">11:00</button>
          <button type="button" class="btn btn-warning">12:00</button>
          <button type="button" class="btn btn-warning">13:00</button>
          <button type="button" class="btn btn-warning">14:00</button>
          <button type="button" class="btn btn-warning">15:00</button>
          <button type="button" class="btn btn-warning">16:00</button>
          <button type="button" class="btn btn-warning">17:00</button>
        </div>
      </div>
      <div class="modal-footer">
        <!-- Button to confirm booking selection -->
        <button type="button" class="btn btn-primary" id="confirmBooking">Confirm Booking</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // weekOffset: 0 = current week, -1 = previous week, 1 = next week, etc.
    let weekOffset = 0;
    
    // Generate week days given the offset
    function generateWeekDays(offset = 0) {
      const weekContainer = document.getElementById("weekDays");
      weekContainer.innerHTML = ""; // Clear previous content

      const today = new Date();
      // Calculate Monday of the current week
      const currentDay = today.getDay(); // 0 (Sun) ... 6 (Sat)
      const diffToMonday = (currentDay === 0 ? -6 : 1 - currentDay);
      const monday = new Date(today);
      monday.setDate(today.getDate() + diffToMonday + (7 * offset));

      // Generate buttons for each day of the week
      for (let i = 0; i < 7; i++) {
        const day = new Date(monday);
        day.setDate(monday.getDate() + i);

        // Format the day as "Mon 12"
        const options = { weekday: 'short' };
        const weekday = day.toLocaleDateString(undefined, options);
        const dateNum = day.getDate();
        const formatted = `${weekday} ${dateNum}`;

        const button = document.createElement("button");
        button.type = "button";
        // Initially, use an outline style for unselected days
        button.className = "btn btn-outline-light";
        button.textContent = formatted;

        // Disable if day is in the past for the current week (only if offset==0)
        const dayOnly = new Date(day.getFullYear(), day.getMonth(), day.getDate());
        const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        if (offset === 0 && dayOnly < todayOnly) {
          button.disabled = true;
          button.classList.add("disabled");
        }

        // Click event to select day
        button.addEventListener("click", function() {
          // Remove active state from all day buttons
          document.querySelectorAll("#weekDays button").forEach(btn => {
            btn.classList.remove("active");
            btn.classList.remove("btn-warning");
            btn.classList.add("btn-outline-light");
          });
          // Mark the clicked button as active: swap style to filled button
          button.classList.add("active");
          button.classList.remove("btn-outline-light");
          button.classList.add("btn-warning");
        });
        weekContainer.appendChild(button);
      }
    }
    
    // Initialize the week days
    generateWeekDays(weekOffset);
    
    // Next and Previous week buttons
    document.getElementById("prevWeek").addEventListener("click", function() {
      weekOffset--;
      generateWeekDays(weekOffset);
    });
    
    document.getElementById("nextWeek").addEventListener("click", function() {
      weekOffset++;
      generateWeekDays(weekOffset);
    });
    
    // Mark time slot buttons as active when clicked
    document.querySelectorAll("#timeSlots button").forEach(button => {
      button.addEventListener("click", function() {
        document.querySelectorAll("#timeSlots button").forEach(btn => btn.classList.remove("active"));
        // For time slots, you may want to change background on active selection
        button.classList.add("active");
      });
    });
    
    // When the user clicks "Confirm Booking"
    document.getElementById("confirmBooking").addEventListener("click", function() {
      const selectedDayBtn = document.querySelector("#weekDays button.active");
      const selectedTimeBtn = document.querySelector("#timeSlots button.active");
      
      if (!selectedDayBtn || !selectedTimeBtn) {
        alert("Please select both a day and a time slot.");
        return;
      }
      
      // Here you would parse selectedDayBtn.textContent into a proper date.
      // For demonstration purposes, we log the values.
      console.log("Selected day:", selectedDayBtn.textContent);
      console.log("Selected time:", selectedTimeBtn.textContent);
      
      // Set hidden fields if necessary (not shown in this snippet)
      // e.g., document.getElementById('id_date').value = computedDate;
      // e.g., document.getElementById('id_time').value = selectedTimeBtn.textContent;
      
      // Close the modal using Bootstrap 5 modal methods
      var bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
      bookingModal.hide();
      
      // Optionally, submit the form automatically:
      // document.getElementById('bookingForm').submit();
    });
  });
</script>

{% endblock %}
